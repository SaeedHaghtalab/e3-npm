# Circular buffer of scalar pv chosen with $(PREFIX,undefined):$(CAM,undefined)-BSZ
# Buffer serves as source for statistics calculations
# Source scalar data is lcoated in $(PREFIX,undefined):$(CAM,undefined)-BSZ
# This record also needs a forward link from $(PREFIX,undefined):$(CAM,undefined)-BSZ
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFER")
{
    field(DESC, "Circular buffer of BSZ")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-BSZ NPP")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(BUFSIZE,undefined)")
    field(EGU,  "mm")
    field(PREC, "$(BSZ_PREC,undefined)")
    field(FLNK, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFOUT")
}

# Fanout to trigger calculations of statistics
record(fanout, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFOUT")
{
    field(DESC, "Fanout to trigger calc of statistics")
    field(LNK2, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-MIN")
    field(LNK3, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-MAX")
    field(LNK4, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-AVG")
}

# Calculate minimum value in circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-MIN")
{
    field(DESC, "Minimum of Circular buffer of BSZ")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFER NPP")
    field(ALG,  "N to 1 Low Value")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "mm")
    field(PREC, "$(BSZ_PREC,undefined)")
    field(FLNK, "")
}

# Calculate maximum value of circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-MAX")
{
    field(DESC, "Maximum of Circular buffer of BSZ")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFER NPP")
    field(ALG,  "N to 1 High Value")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "mm")
    field(PREC, "$(BSZ_PREC,undefined)")
    field(FLNK, "")
}

# Calculate average value of circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-AVG")
{
    field(DESC, "Average of Circular buffer of BSZ")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFER NPP")
    field(ALG,  "N to 1 Average")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "mm")
    field(PREC, "$(BSZ_PREC,undefined)")
    field(FLNK, "")
}

# Circular buffer of scalar pv chosen with $(SIGMA_PV,undefined)
# Buffer serves as source for statistics calculations
# Source scalar data is lcoated in $(SIGMA_PV,undefined)
# This record also needs a forward link from $(SIGMA_PV,undefined)
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFER")
{
    field(DESC, "Circular buffer of SIGMA")
    field(INP,  "$(SIGMA_PV,undefined) NPP")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(BUFSIZE,undefined)")
    field(EGU,  "pixels")
    field(PREC, "$(SIGMA_PREC,undefined)")
    field(FLNK, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFOUT")
}

# Fanout to trigger calculations of statistics
record(fanout, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFOUT")
{
    field(DESC, "Fanout to trigger calc of statistics")
    field(LNK2, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-MIN")
    field(LNK3, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-MAX")
    field(LNK4, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-AVG")
}

# Calculate minimum value in circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-MIN")
{
    field(DESC, "Minimum of Circular buffer of SIGMA")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFER NPP")
    field(ALG,  "N to 1 Low Value")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "pixels")
    field(PREC, "$(SIGMA_PREC,undefined)")
    field(FLNK, "")
}

# Calculate maximum value of circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-MAX")
{
    field(DESC, "Maximum of Circular buffer of SIGMA")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFER NPP")
    field(ALG,  "N to 1 High Value")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "pixels")
    field(PREC, "$(SIGMA_PREC,undefined)")
    field(FLNK, "")
}

# Calculate average value of circular buffer
record(compress, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-AVG")
{
    field(DESC, "Average of Circular buffer of SIGMA")
    field(INP,  "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFER NPP")
    field(ALG,  "N to 1 Average")
    field(NSAM, "1")
    field(N,    "$(BUFSIZE,undefined)")
    field(EGU,  "pixels")
    field(PREC, "$(SIGMA_PREC,undefined)")
    field(FLNK, "")
}

record(calc, "$(PREFIX,undefined):$(CAM,undefined)-BSZ")
{
    field(DESC, "Beam Size minimum value")
    field(CALC, "A * B / 1000")
    field(INPA, "$(SIGMA_PV,undefined) NPP")
    field(INPB, "$(PREFIX,undefined):$(CAM,undefined)-SCALEFACT NPP")
    field(EGU,  "mm")
    field(PREC, "$(BSZ_PREC,undefined)")
    field(FLNK, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-FOUT")
}

record(fanout, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-FOUT")
{
    field(LNK1, "$(PREFIX,undefined):$(CAM,undefined)-BSZ-BUFFER")
    field(LNK2, "$(PREFIX,undefined):$(CAM,undefined)-SIGMA-BUFFER")
}
